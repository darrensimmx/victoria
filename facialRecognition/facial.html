<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Emotion Recognition</title>
    <style>
        #videoElement {
            width: 100%;
            max-width: 500px;
            border: 1px solid #ccc;
        }
        #emotionOutput {
            font-size: 18px;
            margin-top: 20px;
            color: green;
        }
        #startRecognition {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #startRecognition:hover {
            background-color: #45a049;
        }
        #uploadInput {
            margin-top: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/dist/face-api.js"></script>
</head>
<body>
    <h1>Facial Emotion Recognition</h1>

    <!-- Webcam video element -->
    <video id="videoElement" autoplay></video>
    <canvas id="mycanvas"></canvas>
   
    <div id="emotionOutput">Waiting for detection...</div>
    <div id="moodOutput">Mood will be displayed here...</div>

    <!-- Button for starting recognition -->
    <button id="startRecognition">Start Recognition</button>

    <script src="facial.js"></script>
    <script type="module">
        import './facial.js'; // Facial emotion detection logic
        import './intermediate.js'; // Mood calculation logic

        // Variable to track the cooldown state
        let moodCooldown = false;

        // Function to handle pop-ups with cooldown in HTML
        function showMoodPopup() {
            if (window.currMood && !moodCooldown) {
                // Check for mood and popup based on mood
                switch (window.currMood) {
                    case "anger":
                        alert("You're feeling angry. Let's take a 5-minute break!");
                        break;
                    case "disgust":
                        alert("You're feeling disgusted.");
                        break;
                    case "fear":
                        alert("EWWWWW");
                        break;
                    case "surprised":
                        alert("HUHHHHH??????/");
                        break;
                    case "sad":
                        alert("CHEER UP BABY! CHEER UP BABY");
                        break;
                    default:
                        break;
                }
                // Set cooldown to prevent repeated alerts for the same mood
                moodCooldown = true;
                setTimeout(() => {
                    moodCooldown = false; // Reset cooldown after 10 seconds
                }, 10000); // 10-second cooldown
            }
        }

        // Display mood and emotion updates
        setInterval(() => {
            const detectedEmotion = window.currEmotion; // Access the global `currEmotion` variable
            const emotionOutput = document.getElementById('emotionOutput');
            const moodOutput = document.getElementById('moodOutput');

            // Update the emotion display
            if (detectedEmotion) {
                emotionOutput.textContent = `Current Emotion: ${detectedEmotion}`;
            } else {
                emotionOutput.textContent = 'No emotion detected.';
            }

            // Update the mood display
            if (window.currMood) {
                moodOutput.textContent = `Current Mood: ${window.currMood}`;
            } else {
                moodOutput.textContent = 'Mood not yet determined.';
            }

            // Call the function to check and show popup if needed
            showMoodPopup();
        }, 2000); // Update every 2 seconds

        // Start recognition on button click
        document.getElementById('startRecognition').addEventListener('click', () => {
            setupCamera(); // Call the function from `facial.js`
        });

        function showMoodNotification() {
    if (window.currMood && chrome.runtime && chrome.runtime.sendMessage) {
        let notificationMessage = "";
        switch (window.currMood) {
            case "happy":
                notificationMessage = "You look happy! Keep smiling! ðŸ˜Š";
                break;
            case "sad":
                notificationMessage = "You seem sad. Hope things get better soon. ðŸ’™";
                break;
            case "anger":
                notificationMessage = "Take a deep breath. Don't let anger take over. ðŸ˜¡";
                break;
            case "fear":
                notificationMessage = "Feeling scared? You're braver than you think! ðŸŒŸ";
                break;
            case "disgust":
                notificationMessage = "Something bothering you? Hang in there! ðŸ¤¢";
                break;
            case "surprised":
                notificationMessage = "Surprised? Life's full of wonders! ðŸ˜²";
                break;
            default:
                notificationMessage = "Neutral mood detected. Stay balanced. ðŸ™‚";
        }

        // Send the notification via Chrome runtime
        chrome.runtime.sendMessage(
            { moodNotification: notificationMessage },
            (response) => {
                console.log('Notification Triggered:', response);
            }
        );
    } else {
        console.error("Chrome runtime is unavailable. Are you running this inside a Chrome extension?");
    }
}


// Set an interval to check and display notifications every 10 seconds
setInterval(() => {
    showMoodNotification();
}, 10000); // Every 10 seconds

    </script>
</body>
</html>
