<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Emotion Recognition</title>
    <style>
        #videoElement {
            width: 100%;
            max-width: 500px;
            border: 1px solid #ccc;
        }
        #emotionOutput {
            font-size: 18px;
            margin-top: 20px;
            color: green;
        }
        #startRecognition {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #startRecognition:hover {
            background-color: #45a049;
        }
        #toggleMode {
            margin-top: 20px;
            padding: 10px;
            background-color: #008CBA;
            color: white;
            border: none;
            cursor: pointer;
        }
        #toggleMode:hover {
            background-color: #005f7f;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/dist/face-api.js"></script>
</head>
<body>
    <h1>Facial Emotion Recognition</h1>

    <!-- Webcam video element -->
    <video id="videoElement" autoplay></video>
    <canvas id="mycanvas"></canvas>
   
    <div id="emotionOutput">Waiting for detection...</div>
    <div id="moodOutput">Mood will be displayed here...</div>

    <!-- Buttons for starting recognition and toggling mode -->
    <button id="startRecognition">Start Recognition</button>
    <button id="toggleMode">Toggle Mode: Normal</button>

    <script src="facial.js"></script>
    <script type="module">
        import './facial.js'; // Facial emotion detection logic
        import './intermediate.js'; // Mood calculation logic

        // Variable to track the cooldown state and mode
        let moodCooldown = false;
        let normalMode = true;  // Default mode is Normal

        // Function to handle pop-ups with cooldown and different responses for modes
        function showMoodPopup() {
            if (window.currMood && !moodCooldown) {
                // Check for mood and popup based on mood
                switch (window.currMood) {
                    case "anger":
                        if (normalMode) {
                            alert("Calm down... Let's take a 5-minute break!");
                        } else {
                            alert("Relax bro.. it's not that deep");
                        }
                        break;
                    case "disgust":
                        if (normalMode) {
                            alert("Let's unwind what you saw....");
                        } else {
                            alert("Did you look at the mirror??");
                        }
                        break;
                    case "fear":
                        if (normalMode) {
                            alert("EWWWWW");
                        } else {
                            alert("Did you leave your guts at home?");
                        }
                        break;
                    case "surprised":
                        if (normalMode) {
                            alert("Phew...caught me off guard");
                        } else {
                            alert("HUHHH????!??!??!");
                        }
                        break;
                    case "sad":
                        if (normalMode) {
                            alert("CHEER UP BABY! CHEER UP BABY!");
                        } else {
                            alert("Don't be sad, be better");
                        }
                        break;
                    default:
                        break;
                }
                // Set cooldown to prevent repeated alerts for the same mood
                moodCooldown = true;
                setTimeout(() => {
                    moodCooldown = false; // Reset cooldown after 10 seconds
                }, 10000); // 10-second cooldown
            }
        }

        // Display mood and emotion updates
        setInterval(() => {
            const detectedEmotion = window.currEmotion; // Access the global `currEmotion` variable
            const emotionOutput = document.getElementById('emotionOutput');
            const moodOutput = document.getElementById('moodOutput');

            // Update the emotion display
            if (detectedEmotion) {
                emotionOutput.textContent = `Current Emotion: ${detectedEmotion}`;
            } else {
                emotionOutput.textContent = 'No emotion detected.';
            }

            // Update the mood display
            if (window.currMood) {
                moodOutput.textContent = `Current Mood: ${window.currMood}`;
            } else {
                moodOutput.textContent = 'Mood not yet determined.';
            }

            // Call the function to check and show popup if needed
            showMoodPopup();
        }, 2000); // Update every 2 seconds

        // Start recognition on button click
        document.getElementById('startRecognition').addEventListener('click', () => {
            setupCamera(); // Call the function from `facial.js`
        });

        // Toggle mode between Normal and Troll
        document.getElementById('toggleMode').addEventListener('click', () => {
            normalMode = !normalMode;  // Switch the mode
            document.getElementById('toggleMode').textContent = normalMode ? 'Toggle Mode: Normal' : 'Toggle Mode: Troll';  // Update the button text
        });
    </script>
</body>
</html>
